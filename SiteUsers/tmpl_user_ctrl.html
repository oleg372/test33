<div class="user-ctrl">


<div class="user-profile">
  <div class="pic"><img src="{photo}"></div>
  <div class="full-name">
    {last_name} {first_name} <b id="user_id" data-id="{user_id}">ID: {user_id}</b>
    <span class="hot">{is_new_one}</span>
  </div>
  <div class="email"><a href="mailto:{email}">{email}</a></div>
  <div class="phone">{_phone}</div>
  <div class="social">Соц.сеть: <a href="{social_profile}" target="_blank">{network}</a> <i class="icon-external-link-sign"></i></div>
  <div class="addr">{country} {city}</div>
  <div class="additional">

    <span>Первая регистрация: <span>{first_reg}</span></span>
    <span>Дата рождения: <span>{_bDate} {_bTime}</span></span>
    <span>Место рождения: <span>{_bCountry}, {_bCity}</span>
  </div>
  <div class="status">{status}</div>
  <div class="status">Stage: {current_stage}</div>
</div>


<div class="control">
  <h3>Управление пользователем</h3>

  <form class="apply-ctrl" action="{url}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="form" value="change_stage">
    <input type="hidden" name="user_id" value="{user_id}">
    <div class="field">
      <div class="label"> Изменить stage </div>
      <div class="data"> <select name="new_stage" class="ref">{ref_road_map}</select> &nbsp; &nbsp; &nbsp; <a class="js-btn-apply btn btn-small">Применить</a> </div>
    </div>
  </form>
<!--
  <form class="apply-ctrl" action="{url}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="form" value="change_stage">
    <div class="field">
      <div class="label"> Изменить stage </div>
      <div class="data"> <select name="new_stage" class="ref">{ref_road_map}</select> &nbsp; &nbsp; &nbsp; <a class="js-btn-apply btn btn-small">Применить</a> </div>
    </div>
  </form>
-->
</div>


<div class="clr"></div>


<div class="ctrl-list">
  <a class="btn js-btn-tab" data-tab="js-curr-stage" href="javascript:;" >Текущий stage</a>
  <a class="btn js-btn-tab" data-tab="js-road-map" href="javascript:;" >Road map</a>
  <a class="btn js-btn-tab" data-tab="js-reports" href="javascript:;" >Отчеты</a>
  <a class="btn js-btn-tab" data-tab="js-shared-with-me" href="javascript:;" >Предоставлено "мне"</a>
  <a class="btn js-btn-tab" data-tab="js-ud" href="javascript:;" >User data</a>
  <a class="btn js-btn-tab" data-tab="js-soc-net-data" href="javascript:;" >Данные от соц.сети</a>
</div>


<div class="tab-list js-tab-list">

  <div class="tab-item js-tab js-curr-stage">
    <h3>Текущий stage</h3>
    <div class="tab-content"><pre>{now_stage}</pre></div>
  </div>

  <div class="tab-item js-tab js-road-map">
    <h3>Road map of stages / Дорожная карта этапов</h3>
    <div class="tab-content">{road_map}</div>
  </div>

  <div class="tab-item js-tab js-reports">
    <h3>Отчеты</h3>
    <div class="tab-content">
      {reports}
    </div>
  </div>

  <div class="tab-item js-tab js-shared-with-me">
    <h3>С этим пользователем поделились:</h3>
    <div class="tab-content">
      {shared-with-me}
    </div>
    <div class="tab-ctrl formDef">
      <hr>
      <p>Добавить отчет: <input type="text" class="str w300" id="srchReport" value="" placeholder="Поиск отчета по фамилии"> </p>
      <div class="" id="shared-with-me">
        <!-- <p><a href="javascript:;" class="btn btn-small"><i class="icon-plus-sign-alt"></i> Добавить</a> Фамилия Имя <a href="?mm=IDentity&sm=reports&report_id={id_report}" target="_blank">открыть отчет <i class="icon-external-link"></i></a>, владелец отчета, пользователь: <a href="?mm=SiteUsers&sm=&user_id={id_owner}" target="_blank">Фамилия Имя</a></p> -->
      </div>
    </div>
  </div>

  <div class="tab-item js-tab js-ud">
    <h3>User data</h3>
    <div class="tab-content">
      <pre>{ud}</pre>
    </div>
  </div>

  <div class="tab-item js-tab js-soc-net-data">
    <h3>Данные от соц.сети</h3>
    <div class="tab-content"><pre>{sn}</pre></div>
  </div>

</div>


</div>


<script>
$(document).ready(function() 
{
 console.log(window.location.hash);
 $('#srchReport').keyup(function ()
   {
    var q = $.trim($(this).val());
    if (q.length < 1) { $('#shared-with-me').html(''); return; }
    $('#shared-with-me').html('<small>Пожалуйста ждите...</small>');
    $.ajax(
      {
       type: 'POST',
       url: 'aj-mm=SiteUsers&sm=&act=srch_report',
       cache: false,
       dataType: 'json',
       data: 'q='+ q,
       success: function(data)
         {
          $('#shared-with-me').html(data.html);
          $('.js-share-report').click(function () 
            {
             var id_report  = $(this).attr('data-id-report'),
                 id_to_user = $('#user_id').attr('data-id'),
                 id_owner   = $(this).attr('data-id-owner');
             //console.log(id_report, id_to_user, id_owner);
             $.ajax(
               {
                type: 'POST',
                url: 'aj-mm=SiteUsers&sm=&act=share_report',
                cache: false,
                dataType: 'json',
                data: 'id_report='+ id_report +'&id_user='+ id_to_user +'&id_owner='+ id_owner,
                success: function(data) { if (data.msg.length) { $('#shared-with-me').html(data.msg); } else { window.location.reload(true); } },
                error: function(xhr, ajaxOptions, thrownError) { alert('Ошибка'); }
               });

            });
         },
       error: function(xhr, ajaxOptions, thrownError) { alert('Ошибка'); }
      });
   });

 $('.js-remove-share-report').click(function ()
   {
    if (!confirm('Закрыть доступ?')) return false;

             var id_report  = $(this).attr('data-id-report'),
                 id_to_user = $('#user_id').attr('data-id');
             $.ajax(
               {
                type: 'POST',
                url: 'aj-mm=SiteUsers&sm=&act=share_report',
                cache: false,
                dataType: 'json',
                data: 'id_report='+ id_report +'&id_user='+ id_to_user +'&unshare=1',
                success: function(data) { if (data.msg.length) { alert(data.msg); } else { window.location.reload(true); } },
                error: function(xhr, ajaxOptions, thrownError) { alert('Ошибка'); }
               });

   });

});
</script>
